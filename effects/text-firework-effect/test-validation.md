# 文字烟花特效测试验证

## 测试用例

### 1. 基础渲染测试
- **测试目标**：确保视频从头到尾都能正常渲染，不会跳帧或报错
- **测试方法**：
  1. 启动 Remotion Studio
  2. 播放完整视频（300帧，约12.5秒）
  3. 观察时间轴，确保从第0帧到第300帧都能正常播放
- **预期结果**：视频流畅播放，没有跳帧或报错

### 2. 烟花爆炸位置测试
- **测试目标**：验证烟花在正确位置爆炸
- **测试参数**：
  ```json
  {
    "words": ["测试"],
    "launchHeight": 0.2,
    "interval": 30
  }
  ```
- **验证点**：
  - `launchHeight = 0.2` 表示从屏幕顶部向下 20%，即 `targetY = height * 0.2`
  - 第0-30帧：火箭从底部发射
  - 第30帧：烟花在屏幕顶部 20% 位置爆炸（接近顶部）
  - 爆炸位置错落有致，在 0.15-0.25 范围内随机

### 3. 金币雨测试
- **测试目标**：验证金币雨在文字显示结束后正常出现
- **测试参数**：
  ```json
  {
    "words": ["金币"],
    "textDuration": 60,
    "rainDuration": 120,
    "particleCount": 80
  }
  ```
- **验证点**：
  - 第0-30帧：火箭发射
  - 第30-90帧：文字显示
  - 第90帧开始：金币雨出现
  - 金币从爆炸点向上爆发，然后下落
  - 金币在duration结束后消失

### 4. 多个烟花测试
- **测试目标**：验证多个烟花能够错落有致地发射
- **测试参数**：
  ```json
  {
    "words": ["新年快乐", "万事如意", "心想事成", "财源广进", "大吉大利"],
    "interval": 40
  }
  ```
- **验证点**：
  - 每个烟花间隔40帧发射
  - 每个烟花的爆炸高度不同（0.15-0.25范围内）
  - 每个烟花的位置不同
  - 视频流畅，没有卡顿

### 5. 边界条件测试
- **测试目标**：验证边界参数不会导致错误
- **测试用例**：
  - 最小粒子数：`particleCount: 20`
  - 最大粒子数：`particleCount: 200`
  - 最小高度：`launchHeight: 0.1`（顶部10%）
  - 最大高度：`launchHeight: 0.5`（顶部50%）
  - 最小间隔：`interval: 10`
  - 最大间隔：`interval: 60`

### 6. 性能测试
- **测试目标**：验证渲染性能，确保不会卡顿
- **测试方法**：
  - 使用最大粒子数（200）
  - 使用最多文字（5个）
  - 观察渲染时间
- **预期结果**：渲染时间在合理范围内

## 关键修复说明

### launchHeight 参数含义

**正确的理解**：
- `launchHeight` 表示从屏幕**顶部**的距离比例
- `launchHeight = 0.1`：在屏幕顶部 10% 位置爆炸（接近顶部）
- `launchHeight = 0.2`：在屏幕顶部 20% 位置爆炸
- `launchHeight = 0.5`：在屏幕中间爆炸
- `launchHeight = 0.8`：在屏幕顶部 80% 位置爆炸（接近底部）

**计算公式**：
```typescript
targetY = height * launchHeight
```

### 随机数问题

**问题**：
- 所有组件中的 `Math.random()` 会导致每次渲染结果不一致
- Remotion 渲染引擎无法正确处理不一致的帧

**修复**：
- 使用确定性随机数生成器（基于字符串哈希或种子）
- 确保同一帧每次渲染的结果相同

**示例**：
```typescript
const seededRandom = (seed: number) => {
  const x = Math.sin(seed * 9999) * 10000;
  return x - Math.floor(x);
};

const randomValue = seededRandom(index * 7 + 1);
```

## 常见问题排查

### 问题1：视频前几秒报错或跳帧
- **原因**：useMemo 中的 Math.random() 导致每次渲染重新计算
- **修复**：使用确定性随机数生成器
- **验证**：播放视频前6秒，确保流畅

### 问题2：烟花爆炸位置不对
- **原因**：`targetY = height * (1 - launchHeight)` 计算方向错误
- **修复**：改为 `targetY = height * launchHeight`
- **验证**：烟花在屏幕顶部 20% 左右位置爆炸

### 问题3：粒子每次渲染都不同
- **原因**：Math.random() 在每次渲染时生成不同的值
- **修复**：使用确定性随机数，基于固定的种子
- **验证**：多次播放同一帧，粒子位置应该一致

## 测试命令

### 启动 Remotion Studio
```bash
cd effects/text-firework-effect
npm run start
```

### 渲染测试视频
```bash
cd effects/text-firework-effect
npm run render
```

### 渲染预览（前90帧）
```bash
cd effects/text-firework-effect
npm run render-preview
```

## 验证标准

### 通过标准
1. ✅ 视频从第0帧到第300帧都能正常播放，没有跳帧
2. ✅ 烟花在屏幕顶部 20% 左右位置爆炸（launchHeight = 0.2）
3. ✅ 金币雨在文字显示结束后正常出现和消失
4. ✅ 多个烟花能够按照间隔依次发射
5. ✅ 边界参数不会导致错误
6. ✅ 性能良好，没有明显卡顿
7. ✅ 每次播放同一帧，画面一致

### 不通过标准
1. ❌ 视频前几秒报错或跳帧
2. ❌ 烟花位置每次播放都不同
3. ❌ 金币雨不显示或异常
4. ❌ 渲染过程中出现错误
5. ❌ 性能问题导致渲染缓慢